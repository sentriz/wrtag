# set up folder and cover
exec tag-write kat_moda/01.flac Title '"alarms"'
exec tag-write kat_moda/02.flac Title '"the bells"'
exec tag-write kat_moda/03.flac Title '"the bells fesitival mix"'

exec tag-write kat_moda/*.flac MBReleaseID  '"e47d04a4-7460-427d-a731-cc82386d85f1"'
exec tag-write kat_moda/*.flac Album        '"kat moda ep"'
exec tag-write kat_moda/*.flac AlbumArtist  '"jeff pills !! "'
exec tag-write kat_moda/*.flac Label        '"purpose maker"'
exec tag-write kat_moda/*.flac CatalogueNum '"PMD002"'
exec tag-write kat_moda/*.flac MediaFormat  '"digital media"'

exec touch kat_moda/Folder!!.png
exec touch kat_moda/c!!!ccCoveraaaaa.png
exec touch kat_moda/artist.png

env WRTAG_PATH_FORMAT='albums/{{ artists .Release.Artists | sort | join "; " | safepath }}/({{ .Release.ReleaseGroup.FirstReleaseDate.Year }}) {{ .Release.Title | safepath }}/{{ pad0 2 .TrackNum }}.{{ flatTracks .Release.Media | len | pad0 2 }} {{ .Track.Title | safepath }}{{ .Ext }}'

# we exit if score too low
! exec wrtag move kat_moda/
stderr 'matched \d\d.\d\d% with'
stderr 'score too low'

# but can overwrite with -yes
exec wrtag -yes move kat_moda/

# make sure dest dir looks ok according to format
exec find albums/
cmp stdout exp-layout

# since we did a move, see if src folder was cleaned up
! exists kat_moda

# check new tags
cd 'albums/Jeff Mills/(1997) Kat Moda/'
exec tag-check 02*.flac Album            '"Kat Moda"'
exec tag-check 02*.flac AlbumArtist      '"Jeff Mills"'
exec tag-check 02*.flac AlbumArtists     '["Jeff Mills"]'
exec tag-check 02*.flac Date             '"2001-01-01T00:00:00Z"'
exec tag-check 02*.flac OriginalDate     '"1997-01-01T00:00:00Z"'
exec tag-check 02*.flac MediaFormat      '"Digital Media"'
exec tag-check 02*.flac Label            '"Purpose Maker"'
exec tag-check 02*.flac CatalogueNum     '"PMD002"'
exec tag-check 02*.flac MBReleaseID      '"e47d04a4-7460-427d-a731-cc82386d85f1"'
exec tag-check 02*.flac MBReleaseGroupID '"acb38b21-9063-3ea3-b578-35c14d9aa488"'
exec tag-check 02*.flac MBAlbumArtistID  '["470a4ced-1323-4c91-8fd5-0bb3fb4c932a"]'
exec tag-check 02*.flac Title            '"The Bells"'
exec tag-check 02*.flac Artist           '"Jeff Mills"'
exec tag-check 02*.flac Artists          '["Jeff Mills"]'
exec tag-check 02*.flac Genre            '"electronic"'
exec tag-check 02*.flac Genres           '["electronic", "techno"]'
exec tag-check 02*.flac DiscNumber       '1'
exec tag-check 02*.flac MBRecordingID    '"a8ea2c29-1c4b-456d-a977-19497a11f0a8"'
exec tag-check 02*.flac MBArtistID       '["470a4ced-1323-4c91-8fd5-0bb3fb4c932a"]'

exec tag-check 01*.flac TrackNumber 1
exec tag-check 02*.flac TrackNumber 2
exec tag-check 03*.flac TrackNumber 3

cd $WORK

cp 'albums/Jeff Mills/(1997) Kat Moda/01.03 Alarms.flac' tr-1-copy

# move again to the same dir should be a no-op
exec wrtag move 'albums/Jeff Mills/(1997) Kat Moda/'
stderr 'matched 100.00%'

exec find albums/
cmp stdout exp-layout

cmp 'albums/Jeff Mills/(1997) Kat Moda/01.03 Alarms.flac' tr-1-copy

-- exp-layout --
albums/
albums/Jeff Mills
albums/Jeff Mills/(1997) Kat Moda
albums/Jeff Mills/(1997) Kat Moda/01.03 Alarms.flac
albums/Jeff Mills/(1997) Kat Moda/02.03 The Bells.flac
albums/Jeff Mills/(1997) Kat Moda/03.03 The Bells (Festival mix).flac
albums/Jeff Mills/(1997) Kat Moda/cover.png
